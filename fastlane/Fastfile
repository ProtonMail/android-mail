# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:android)

platform :android do

  desc "Execute static analysis"
  lane :analyse do
    gradle(task: "detekt")
  end

  desc "Assemble the debug apk"
  lane :assembleDebug do
    gradle(task: "assembleDevDebug")
  end

  desc "Assemble the test apk"
  lane :assembleTest do
    gradle(task: "assembleDevDebugAndroidTest")
  end

  desc "Assemble the release apk"
  lane :assembleRelease do
    gradle(task: "assembleRelease")
  end

  desc "Runs Unit Tests"
  lane :unitTest do
    gradle(task: "test")
  end

  desc "Runs Instrumented Tests on Firebase"
  lane :instrumentedTest do
    sh("../buildSrc/run_firebase_instrumentation_tests.sh")
  end

  desc "Runs Smoke Tests Suite on Firebase Test lab"
  lane :smokeTest do
    sh("../buildSrc/run_firebase_ui_tests.sh")
  end

  desc "Runs extended Smoke Tests Suite on Firebase Test lab"
  lane :smokeTestExtended do
    sh("../buildSrc/run_firebase_ui_tests.sh extended_test")
  end

  desc "Runs all UI tests on a wide set of devices on Firebase Test lab"
  lane :fullRegressionTest do
    sh("../buildSrc/run_firebase_ui_tests.sh full_test")
  end

  desc "Generate test coverage report based on the last test run"
  lane :coverageReport do
    gradle(task: "-Pci --console=plain coberturaCoverageReport")
  end

  desc "Publish alpha build to firebase dev group"
  lane :deployToFirebaseDevGroup do
    firebase_app_distribution(
      app: '1:75309174866:android:d354e9e5da9113aa78cf8b',
      android_artifact_path: 'app/build/outputs/apk/alpha/release/app-alpha-release.apk',
      # Service account is created on the CI from an env var each run (destroyed when finishing)
      service_credentials_file: '/tmp/service-account.json',
      groups: 'v6-dev-builds-testers'
    )
  end

  desc "Publish alpha build to firebase alpha group"
  lane :deployToFirebaseAlphaGroup do
    firebase_app_distribution(
      app: '1:75309174866:android:d354e9e5da9113aa78cf8b',
      android_artifact_path: 'app/build/outputs/apk/alpha/release/app-alpha-release.apk',
      # Service account is created on the CI from an env var each run (destroyed when finishing)
      service_credentials_file: '/tmp/service-account.json',
      groups: 'v6-internal-alpha-testers'
    )
  end

  desc "Submit a new Closed-Testing Build in Alpha-v6 track to Play Store"
  lane :deployToPlayStoreAlpha do
    upload_to_play_store(track: 'alpha-v6', apk: 'app/build/outputs/apk/release/app-release.apk')
  end

end

