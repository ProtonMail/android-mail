cache: &cache
  key: $CI_COMMIT_SHA
  paths:
    - ${CI_PROJECT_DIR}
  untracked: true

.base_job:
  cache:
    *cache

.build_job:
  stage: build
  extends: .base_job
  tags:
    - xlarge-k8s
  artifacts:
    paths:
      - app/build/outputs

.firebase_test_job:
  stage: test
  dependencies:
    - build_dev_debug
  tags:
    - small
  before_script:
    - bundle install
    - ./scripts/setup_firebase_gcloud.sh
  cache:
    *cache

.firebase_deploy_job:
  interruptible: false
  stage: deploy
  dependencies:
    - build_alpha_release
  tags:
    - small
  before_script:
    - bundle install
    - echo $SERVICE_ACCOUNT_MAIL > /tmp/service-account.json
    - ./scripts/release/generate_git_release_notes.sh /tmp/release_notes.txt
  rules:
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"
      when: never
  cache:
    *cache
